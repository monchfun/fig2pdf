<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF颜色转换工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        .step-indicator {
            transition: all 0.3s ease;
        }
        .step-indicator.active {
            background-color: #3b82f6;
            color: white;
        }
        .step-indicator.completed {
            background-color: #10b981;
            color: white;
        }
        .step-content {
            display: none;
        }
        .step-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .json-editor {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl" x-data="pdfProcessor()">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">PDF颜色转换工具</h1>
        
        <!-- 步骤指示器 -->
        <div class="flex justify-center mb-8">
            <div class="flex space-x-4">
                <div class="step-indicator px-4 py-2 rounded-full text-sm font-medium" 
                     :class="{'active': currentStep === 1, 'completed': currentStep > 1}">
                    步骤 1: 上传PDF
                </div>
                <div class="step-indicator px-4 py-2 rounded-full text-sm font-medium" 
                     :class="{'active': currentStep === 2, 'completed': currentStep > 2}">
                    步骤 2: 配置颜色映射
                </div>
                <div class="step-indicator px-4 py-2 rounded-full text-sm font-sm font-medium" 
                     :class="{'active': currentStep === 3, 'completed': currentStep > 3}">
                    步骤 3: 处理与下载
                </div>
            </div>
        </div>

        <!-- 步骤1: 上传PDF -->
        <div class="step-content bg-white rounded-lg shadow-md p-6 mb-6" :class="{'active': currentStep === 1}">
            <h2 class="text-xl font-semibold mb-4">步骤1: 上传PDF文件</h2>
            
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                <input type="file" 
                       id="pdfFile" 
                       accept=".pdf" 
                       class="hidden" 
                       @change="handlePdfUpload">
                
                <div class="space-y-4">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    
                    <div>
                        <button type="button" 
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700"
                                onclick="document.getElementById('pdfFile').click()">
                            选择PDF文件
                        </button>
                        <p class="mt-2 text-sm text-gray-500" x-text="pdfFileName || '或拖拽文件到此处'"></p>
                    </div>
                </div>
            </div>

            <div x-show="uploadProgress > 0" class="mt-4">
                <div class="flex justify-between text-sm text-gray-600 mb-1">
                    <span>上传进度</span>
                    <span x-text="uploadProgress + '%'"></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="progress-bar bg-blue-600 h-2 rounded-full" :style="`width: ${uploadProgress}%`"></div>
                </div>
            </div>

            <div class="mt-6 flex justify-end">
                <button @click="nextStep()" 
                        :disabled="!pdfUploaded"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    下一步
                </button>
            </div>
        </div>

        <!-- 步骤2: 配置颜色映射 -->
        <div class="step-content bg-white rounded-lg shadow-md p-6 mb-6" :class="{'active': currentStep === 2}">
            <h2 class="text-xl font-semibold mb-4">步骤2: 配置颜色映射</h2>
            
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-medium">颜色映射配置</h3>
                    <div class="space-x-2">
                        <button @click="resetToOriginalDefault()" 
                                class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            重置为默认
                        </button>
                        <button @click="saveMapping()" 
                                class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700">
                            保存为默认
                        </button>
                        <button @click="addNewColor()"
                                class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">
                            添加颜色
                        </button>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        上传自定义JSON文件（可选）
                    </label>
                    <input type="file" 
                           accept=".json" 
                           @change="handleJsonUpload"
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- 表格视图 -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">映射表格</h4>
                        <div class="border rounded-lg overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">颜色名称</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">RGB</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">CMYK</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <template x-for="(mapping, index) in colorMappings.mappings" :key="index">
                                        <tr>
                                            <td class="px-4 py-2 text-sm flex items-center">
                                                <span class="inline-block w-5 h-5 rounded-full border border-gray-300 mr-2"
                                                      :style="`background-color: rgb(${mapping.rgb_255[0]}, ${mapping.rgb_255[1]}, ${mapping.rgb_255[2]})`"></span>
                                                <input type="text" 
                                                       x-model="mapping.name" 
                                                       @input="syncJsonFromTable()"
                                                       class="w-full border-none outline-none">
                                            </td>
                                            <td class="px-4 py-2 text-sm">
                                                <input type="text" 
                                                       :value="mapping.rgb_255.join(', ')"
                                                       @input="updateRgb(index, $event.target.value)"
                                                       class="w-full border-none outline-none">
                                            </td>
                                            <td class="px-4 py-2 text-sm">
                                                <input type="text" 
                                                       :value="mapping.cmyk_100.join(', ')"
                                                       @input="updateCmyk(index, $event.target.value)"
                                                       class="w-full border-none outline-none">
                                            </td>
                                            <td class="px-4 py-2 text-sm">
                                                <button @click="deleteColor(index)"
                                                        class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600">
                                                    删除
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- JSON视图 -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">JSON配置</h4>
                        <textarea x-model="jsonText" 
                                  @input="syncTableFromJson()"
                                  class="json-editor w-full h-64 p-3 border rounded-lg resize-none"
                                  placeholder="JSON配置将在这里显示..."></textarea>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-between">
                <button @click="previousStep()" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                    上一步
                </button>
                <button @click="nextStep()" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    下一步
                </button>
            </div>
        </div>

        <!-- 步骤3: 处理与下载 -->
        <div class="step-content bg-white rounded-lg shadow-md p-6 mb-6" :class="{'active': currentStep === 3}">
            <h2 class="text-xl font-semibold mb-4">步骤3: 处理与下载</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" x-model="convertTextToCurves" class="rounded border-gray-300">
                        <span class="ml-2 text-sm text-gray-700">将文字转为曲线（适用于印刷）</span>
                    </label>
                </div>

                <button @click="processPdf()" 
                        :disabled="processing"
                        class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!processing">开始处理</span>
                    <span x-show="processing">处理中...</span>
                </button>

                <div x-show="processing" class="text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <p class="mt-2 text-sm text-gray-600">正在处理PDF文件...</p>
                </div>

                <div class="text-center space-y-2">
                    <a x-show="cmykDownloadUrl" :href="cmykDownloadUrl" 
                       download
                       class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                        下载CMYK转换PDF
                    </a>
                    <a x-show="finalDownloadUrl" :href="finalDownloadUrl" 
                       download
                       class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                        下载最终处理PDF
                    </a>
                </div>
            </div>

            <div class="mt-6 flex justify-between">
                <button @click="previousStep()" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                    上一步
                </button>
                <button @click="resetProcess()" 
                        class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                    重新开始
                </button>
            </div>
        </div>

        <!-- 历史记录 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">历史记录</h2>
            
            <div x-show="history.length === 0" class="text-center text-gray-500">
                <p>暂无历史记录。</p>
            </div>

            <div x-show="history.length > 0" class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">时间</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">原始PDF</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">CMYK PDF</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">最终PDF</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">映射JSON</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="record in history" :key="record.upload_id">
                            <tr>
                                <td class="px-4 py-2 text-sm" x-text="record.timestamp"></td>
                                <td class="px-4 py-2 text-sm">
                                    <a x-show="record.original_pdf" :href="`/download/${record.upload_id}/${record.original_pdf}`" download class="text-blue-600 hover:underline" x-text="record.original_pdf"></a>
                                    <span x-show="!record.original_pdf" class="text-gray-400">无</span>
                                </td>
                                <td class="px-4 py-2 text-sm">
                                    <a x-show="record.cmyk_pdf" :href="`/download/${record.upload_id}/${record.cmyk_pdf}`" download class="text-blue-600 hover:underline" x-text="record.cmyk_pdf"></a>
                                    <span x-show="!record.cmyk_pdf" class="text-gray-400">无</span>
                                </td>
                                <td class="px-4 py-2 text-sm">
                                    <a x-show="record.final_pdf" :href="`/download/${record.upload_id}/${record.final_pdf}`" download class="text-blue-600 hover:underline" x-text="record.final_pdf"></a>
                                    <span x-show="!record.final_pdf" class="text-gray-400">无</span>
                                </td>
                                <td class="px-4 py-2 text-sm">
                                    <a x-show="record.json_mapping" :href="`/download/${record.upload_id}/${record.json_mapping}`" download class="text-blue-600 hover:underline" x-text="record.json_mapping"></a>
                                    <span x-show="!record.json_mapping" class="text-gray-400">无</span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <div class="mt-6 flex justify-end"> <!-- Changed to justify-end -->
                <button @click="clearHistory()" 
                        class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                    清空历史记录
                </button>
            </div>
        </div>
    </div>

    <script>
        function pdfProcessor() {
            return {
                currentStep: 1,
                pdfFile: null,
                pdfFileName: '',
                pdfUploaded: false,
                uploadProgress: 0,
                colorMappings: { mappings: [] },
                jsonText: '',
                convertTextToCurves: false,
                processing: false,
                downloadUrl: '', // Keep for now, might be removed later
                uploadId: '',
                cmykDownloadUrl: '', // New
                finalDownloadUrl: '', // New
                history: [], // Re-add history data property

                init() {
                    this.loadDefaultMapping();
                    this.fetchHistory(); // Fetch history on init
                },

                async loadDefaultMapping() {
                    try {
                        const response = await fetch('/api/color-mapping');
                        const data = await response.json();
                        this.colorMappings = data;
                        this.jsonText = JSON.stringify(data, null, 2);
                    } catch (error) {
                        console.error('加载默认映射失败:', error);
                    }
                },

                async resetToOriginalDefault() {
                    try {
                        const response = await fetch('/api/original-color-mapping');
                        const data = await response.json();
                        this.colorMappings = data;
                        this.jsonText = JSON.stringify(data, null, 2);
                    } catch (error) {
                        console.error('加载原始默认映射失败:', error);
                    }
                },

                async saveMapping() {
                    try {
                        const response = await fetch('/api/color-mapping', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(this.colorMappings)
                        });
                        const result = await response.json();
                        if (result.success) {
                            alert('颜色映射已保存为默认配置');
                        }
                    } catch (error) {
                        alert('保存失败: ' + error.message);
                    }
                },

                async handlePdfUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    this.pdfFile = file;
                    this.pdfFileName = file.name;

                    const formData = new FormData();
                    formData.append('pdf_file', file);

                    try {
                        const xhr = new XMLHttpRequest();
                        
                        xhr.upload.addEventListener('progress', (e) => {
                            if (e.lengthComputable) {
                                this.uploadProgress = Math.round((e.loaded / e.total) * 100);
                            }
                        });

                        xhr.addEventListener('load', () => {
                            if (xhr.status === 200) {
                                const response = JSON.parse(xhr.responseText);
                                if (response.success) {
                                    this.uploadId = response.upload_id;
                                    this.pdfUploaded = true;
                                    this.uploadProgress = 100;
                                }
                            }
                        });

                        xhr.open('POST', '/api/upload-pdf');
                        xhr.send(formData);
                    } catch (error) {
                        console.error('上传失败:', error);
                    }
                },

                handleJsonUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            this.colorMappings = data;
                            this.jsonText = JSON.stringify(data, null, 2);
                        } catch (error) {
                            alert('JSON文件格式错误');
                        }
                    };
                    reader.readAsText(file);
                },

                syncJsonFromTable() {
                    this.jsonText = JSON.stringify(this.colorMappings, null, 2);
                },

                syncTableFromJson() {
                    try {
                        const data = JSON.parse(this.jsonText);
                        this.colorMappings = data;
                    } catch (error) {
                        // JSON格式错误时不更新表格
                    }
                },

                updateRgb(index, value) {
                    const rgb = value.split(',').map(v => parseInt(v.trim()));
                    if (rgb.length === 3 && rgb.every(v => !isNaN(v) && v >= 0 && v <= 255)) {
                        this.colorMappings.mappings[index].rgb_255 = rgb;
                        this.syncJsonFromTable();
                    }
                },

                updateCmyk(index, value) {
                    const cmyk = value.split(',').map(v => parseInt(v.trim()));
                    if (cmyk.length === 4 && cmyk.every(v => !isNaN(v) && v >= 0 && v <= 100)) {
                        this.colorMappings.mappings[index].cmyk_100 = cmyk;
                        this.syncJsonFromTable();
                    }
                },

                addNewColor() {
                    this.colorMappings.mappings.push({
                        name: '新颜色',
                        rgb_255: [0, 0, 0],
                        cmyk_100: [0, 0, 0, 100]
                    });
                    this.syncJsonFromTable();
                },

                deleteColor(index) {
                    if (confirm('确定要删除此颜色映射吗？')) {
                        this.colorMappings.mappings.splice(index, 1);
                        this.syncJsonFromTable();
                    }
                },

                nextStep() {
                    if (this.currentStep < 4) { // Changed from 3 to 4
                        this.currentStep++;
                        if (this.currentStep === 4) {
                            this.fetchHistory(); // Fetch history when navigating to step 4
                        }
                    }
                },

                previousStep() {
                    if (this.currentStep > 1) {
                        this.currentStep--;
                    }
                },

                async processPdf() {
                    this.processing = true;
                    this.cmykDownloadUrl = '';
                    this.finalDownloadUrl = '';
                    
                    try {
                        // 创建临时JSON文件
                        const jsonBlob = new Blob([this.jsonText], { type: 'application/json' });
                        const jsonFile = new File([jsonBlob], 'color_mapping.json');
                        
                        const formData = new FormData();
                        formData.append('pdf_file', this.pdfFile);
                        formData.append('json_file', jsonFile);
                        formData.append('convert_text', this.convertTextToCurves);

                        const response = await fetch('/process', {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();
                        
                        if (result.success) {
                            this.uploadId = result.upload_id;
                            if (result.cmyk_pdf_filename) {
                                this.cmykDownloadUrl = `/download/${result.upload_id}/${result.cmyk_pdf_filename}`;
                            }
                            if (result.final_pdf_filename) {
                                this.finalDownloadUrl = `/download/${result.upload_id}/${result.final_pdf_filename}`;
                            }
                            // Directly update history from the response
                            if (result.history) {
                                this.history = result.history;
                            }
                        } else {
                            alert('处理失败: ' + result.message);
                        }
                    } catch (error) {
                        alert('处理失败: ' + error.message);
                    } finally {
                        this.processing = false;
                    }
                },

                resetProcess() {
                    this.currentStep = 1;
                    this.pdfFile = null;
                    this.pdfFileName = '';
                    this.pdfUploaded = false;
                    this.uploadProgress = 0;
                    this.downloadUrl = '';
                    this.uploadId = '';
                    document.getElementById('pdfFile').value = '';
                    this.loadDefaultMapping();
                },

                async fetchHistory() { // New method
                    try {
                        const response = await fetch('/api/history?t=' + new Date().getTime());
                        const data = await response.json();
                        this.history = data;
                    } catch (error) {
                        console.error('获取历史记录失败:', error);
                    }
                },

                async clearHistory() {
                    if (confirm('确定要清空所有历史记录吗？此操作不可撤销。')) {
                        try {
                            const response = await fetch('/api/clear-history', { method: 'POST' });
                            const result = await response.json();
                            if (result.success) {
                                alert(result.message);
                                this.fetchHistory(); // Re-fetch history after clearing
                            } else {
                                alert('清空失败: ' + result.message);
                            }
                        } catch (error) {
                            alert('清空失败: ' + error.message);
                        }
                    }
                }
            }
        }
    </script>
</body>
</html>
