# 项目日志：Figma to Print-Ready PDF 自动化流程

**最后更新时间**: 2025-09-26

## 1. 项目总体目标

创建一个完整的自动化工作流，允许用户从 Figma 设计稿开始，通过自定义的颜色映射，最终生成一个颜色精确、保留矢量格式、可直接交付印刷的 PDF 文件。

---

## 2. 已完成模块和状态

### 模块一：PDF 颜色转换与处理脚本

- **状态**: ✅ **完成并已验证**
- **目的**: 将一个标准的RGB PDF，根据JSON映射表，转换为颜色精确的CMYK印刷级PDF。
- **技术栈**: `Python`, `pikepdf` 库, `Ghostscript`
- **核心文件**: `process_pdf.py`, `color_mapping.json`
- **关键技术点**:
    1.  采用两步流程，先替换颜色再进行标准化，以确保稳定性和精确性。
    2.  使用 `pikepdf` 在PDF底层内容流中直接将RGB颜色定义替换为指定的CMYK颜色定义，保证了100%的颜色准确性。
    3.  调用 `Ghostscript` 时，使用 `-dUseCIEColor=false` 参数禁用了其自动色彩管理，这是成功保留精确CMYK值的关键。
    4.  最终脚本能生成保留矢量格式的现代化PDF，避免了内容被栅格化（变成图片）的问题。

### 模块二：Figma 插件

- **状态**: ✅ **基础功能已搭建**
- **目的**: 在 Figma 环境中提供一个图形界面，让用户可以方便地选择颜色、设置CMYK映射值，并一键导出源PDF和对应的`color_mapping.json`文件。
- **技术栈**: `Figma 插件 API`, `JavaScript`, `HTML/CSS`
- **核心文件**: `manifest.json`, `code.js`, `ui.html`
- **关键技术点**:
    1.  插件UI (`ui.html`) 与核心逻辑 (`code.js`) 通过消息传递进行通信。
    2.  能通过 `figma.on('selectionchange')` 自动检测用户选择的元素并提取其中的纯色。
    3.  UI界面能动态展示所选颜色，并提供CMYK输入框。
    4.  导出功能通过 `figma.exportAsync` 实现PDF导出，并通过 `postMessage` 将文件数据发送回UI，由UI的JS代码触发浏览器下载。

### 模块三：Web 应用程序

- **状态**: ✅ **完成并已验证**
- **目的**: 提供一个用户友好的Web界面，允许用户上传PDF文件和颜色映射JSON文件，自动处理并下载转换后的印刷级PDF。
- **技术栈**: `Python Flask`, `HTML/CSS/JavaScript`, `Tailwind CSS`
- **核心文件**: `app.py`, `process_pdf.py`, `templates/*.html`
- **关键技术点**:
    1.  **后端**: 使用 Flask 框架构建 RESTful API，支持文件上传、下载和处理历史记录等功能。
    2.  **前端**: 使用 Alpine.js 和 Tailwind CSS 构建了响应式的单页应用界面，提供了流畅的、无需页面刷新的用户体验。
    3.  **文件处理**: 集成核心的 `process_pdf.py` 脚本，并使用 UUID 为每次上传创建独立会话目录，确保文件隔离与安全。
    4.  **交互式编辑**: 提供了交互式的颜色映射编辑器，支持实时修改、添加、删除颜色，并同步更新 JSON 文本视图。
    5.  **历史记录**: 实现了文件处理历史功能。处理完成后，列表会自动更新，方便用户随时追溯和下载过往文件。

---

## 3. 后续步骤 (To-Do)

1.  **测试 Figma 插件**: 您需要按照说明，在Figma桌面应用中加载并实际测试插件的功能是否符合预期。
2.  **测试 Web 应用**: 验证Web应用的文件上传、处理和下载功能是否正常工作。
3.  **部署与整合**: 
    -   **本地流程**: 您现在可以在本地使用"Figma插件导出 -> Web应用处理"的完整流程。
    -   **云端自动化 (可选)**: 未来的一个方向，可以将Web应用部署到云服务器，实现完全的云端自动化处理。
4.  **优化与迭代**: 根据实际使用情况，可能需要对Figma插件的UI/UX、Web应用的用户体验或Python脚本的错误处理等进行优化。


---

## 4. 开发与维护日志

### 2025-08-26
- **优化**: 优化了 Web 应用的用户体验。
- **修复**: 修复了一个 bug，该 bug 导致在处理完新的 PDF 后，前端的历史记录列表不会自动刷新。
- **实现**:
    - 重构了前后端交互逻辑。现在，处理接口 (`/process`) 在成功后会直接返回最新的完整历史记录。
    - 前端直接使用接口返回的数据更新视图，移除了额外的刷新请求，从根本上解决了之前由于缓存、时序等多种原因导致的刷新失败问题。
    - 提高了应用的健壮性和用户体验的流畅性。

### 2025-09-24
- **修复**: 解决了后端服务启动失败的问题。
    - **问题**: `ModuleNotFoundError: No module named 'sklearn'`，原因是 `gunicorn` 运行时未激活正确的 Python 虚拟环境。
    - **解决方案**: 修改 `backend/start.sh` 脚本，在启动 `gunicorn` 之前激活 `backend/venv` 虚拟环境。
- **修复**: 解决了前端 `500 Internal Server Error` 的问题。
    - **问题**: 前端代理配置 (`vue-app/vite.config.js`) 指向后端端口 `5002`，而后端实际运行在 `5001` 端口。
    - **解决方案**: 更新 `vue-app/vite.config.js` 中的代理配置，将目标端口从 `5002` 修改为 `5001`。
- **优化**: 统一了后端服务启动端口为 `5001`，与 `app.py` 中的默认配置保持一致。

### 2025-09-26
- **重构**: 将前端应用从传统的模板引擎重构为现代化的 Vue.js 3 单页应用。
  - **技术栈升级**: 从 Alpine.js + Tailwind CSS 升级到 Vue.js 3 + Vite + shadcn-vue
  - **组件化设计**: 实现了完整的组件化架构，包括文件上传、PDF预览、颜色映射配置、历史记录管理等
  - **用户体验提升**: 提供了更流畅的交互体验和现代化的UI界面
- **功能增强**:
  - **颜色预览功能**: 在颜色映射配置中添加了CMYK颜色实时预览，用户可以直观地看到CMYK值对应的颜色效果
  - **按钮样式优化**: 改进了下载按钮的视觉层次，印刷最终版按钮使用默认样式，CMYK替换版使用outline样式
  - **界面布局**: 优化了按钮间距和整体布局，提升了视觉体验
- **数据库集成**: 集成了SQLite数据库用于历史记录管理，替代了之前的JSON文件存储方式
- **后端优化**: 添加了Flask-SQLAlchemy支持，实现了数据的持久化存储和查询
- **开发体验**: 配置了Vite开发服务器，支持热重载和现代化的开发体验